name: Check

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Check for self links
        run: |
          find ./docs -type f -exec awk '
            /docs\.flathub\.org\/docs/ {
              print "Error: Found docs.flathub.org/docs link in " FILENAME;
              exit 1
            }' {} +

      - name: Check for self link in blog authors
        run: |
          awk '
            /docs\.flathub\.org/ {
              print "Error: Found docs.flathub.org link in blog/authors.yml";
              exit 1
            }' blog/authors.yml

      - name: Check for HTTP links
        run: |
          find ./docs ./blog -type f ! -name "*.png" ! -name "*.svg" -exec awk '
            /http:\/\/[^\s]+/ {
              print "Error: Found HTTP link in " FILENAME;
              exit 1
            }' {} +

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          package-manager-cache: false

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT

      - name: Cache yarn
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-check-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-check-

      - name: Install dependencies
        run: yarn install --frozen-lockfile --prefer-offline

      - name: Typecheck
        run: yarn typecheck

      - name: Build application
        run: yarn build
        env:
          CI: true

  deploy-call:
    needs:
      - check
    permissions:
      pages: write
      id-token: write
      contents: read
    if: ${{ github.event_name != 'pull_request' && github.ref == 'refs/heads/main' }}
    uses: ./.github/workflows/deploy.yml
